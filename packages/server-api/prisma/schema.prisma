generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum TemplateStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum ScopeType {
  BRAND
  MAIN
}

/* =======================
   ADMIN USERS
======================= */

model AdminUser {
  id           String   @id @default(uuid())
  email        String   @unique
  passwordHash String   @map("password_hash")
  role         String   @default("SUPER_ADMIN")
  createdAt    DateTime @map("created_at") @default(now())
  updatedAt    DateTime @map("updated_at") @updatedAt

  sessions     AdminSession[]
  templateVersions TemplateVersion[]
  pageVersions     InnerPageVersion[]

  @@map("admin_users")
}

/* =======================
   ADMIN SESSIONS
======================= */

model AdminSession {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  token     String   @unique
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @map("created_at") @default(now())

  user      AdminUser @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
  @@map("admin_sessions")
}

/* =======================
   BRANDS
======================= */

model Brand {
  id            String   @id @default(uuid())
  slug          String   @unique
  name          String
  route         String
  status        String   @default("ACTIVE")
  primaryDomain String?  @map("primary_domain")

  accentColor   String?  @map("accent_color")
  logoUrl       String?  @map("logo_url")
  typography    String?

  createdAt     DateTime @map("created_at") @default(now())
  updatedAt     DateTime @map("updated_at") @updatedAt

  templates     Template[]
  innerPages    InnerPage[]

  @@index([status])
  @@map("brands")
}

/* =======================
   TEMPLATES
======================= */

model Template {
  id        String         @id @default(uuid())
  scope     ScopeType
  brandId   String?        @map("brand_id")
  key       String
  title     String
  status    TemplateStatus @default(DRAFT)
  createdAt DateTime       @map("created_at") @default(now())
  updatedAt DateTime       @map("updated_at") @updatedAt

  brand     Brand?         @relation(fields: [brandId], references: [id], onDelete: Cascade)
  versions  TemplateVersion[]

  @@unique([scope, brandId, key])
  @@index([brandId])
  @@index([scope])
  @@index([status])
  @@map("templates")
}

/* =======================
   TEMPLATE VERSIONS
======================= */

model TemplateVersion {
  id         String   @id @default(uuid())
  templateId String   @map("template_id")
  version    Int
  content    Json     @default("{}")
  createdAt  DateTime @map("created_at") @default(now())
  createdBy  String?  @map("created_by")

  template   Template   @relation(fields: [templateId], references: [id], onDelete: Cascade)
  admin      AdminUser? @relation(fields: [createdBy], references: [id], onDelete: SetNull)

  @@unique([templateId, version])
  @@index([templateId])
  @@index([createdAt])
  @@map("template_versions")
}

/* =======================
   INNER PAGES
======================= */

model InnerPage {
  id        String         @id @default(uuid())
  scope     ScopeType
  brandId   String?        @map("brand_id")
  slug      String
  title     String
  status    TemplateStatus @default(DRAFT)
  createdAt DateTime       @map("created_at") @default(now())
  updatedAt DateTime       @map("updated_at") @updatedAt

  brand     Brand?         @relation(fields: [brandId], references: [id], onDelete: Cascade)
  versions  InnerPageVersion[]

  @@unique([scope, brandId, slug])
  @@index([brandId])
  @@index([scope])
  @@index([status])
  @@map("inner_pages")
}

/* =======================
   INNER PAGE VERSIONS
======================= */

model InnerPageVersion {
  id        String   @id @default(uuid())
  pageId    String   @map("page_id")
  version   Int
  content   Json     @default("{}")
  createdAt DateTime @map("created_at") @default(now())
  createdBy String?  @map("created_by")

  page      InnerPage @relation(fields: [pageId], references: [id], onDelete: Cascade)
  admin     AdminUser? @relation(fields: [createdBy], references: [id], onDelete: SetNull)

  @@unique([pageId, version])
  @@index([pageId])
  @@index([createdAt])
  @@map("inner_page_versions")
}
